@model ZedCars.Net8.ViewModels.AdminCont.AdminDashboardViewModel

@{
    ViewData["Title"] = "Admin Dashboard";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="admin-header p-4">
    <h1>Dashboard</h1>
    <p class="lead">Manage your ZedCars inventory and users</p>

    <div class="admin-actions d-flex justify-content-start align-items-center">
        <a href="/Admin/AddVehicle" class="btn btn-primary">Add New Vehicle</a>

        @if (User.IsInRole("SuperAdmin"))
        {
            <a href="/Admin/Inventory" class="btn btn-secondary">Manage Vehicles</a>
        }

        <a href="/Accessory/Index" class="btn btn-secondary">Manage Accessories</a>

        @if (User.IsInRole("SuperAdmin"))
        {
            <a href="/Admin/ManageUsers" class="btn btn-secondary">Manage Users</a>
        }

        <a href="/Reports/SalesReport" class="btn btn-secondary">View Reports</a>
        @* <a href="@Url.Action("ExportDashboardExcel", "Admin")" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a> *@
    </div>
</div>

<div class="container my-4">
    <div class="dashboard-overview">
        <h2 class="mb-4">üìä Dashboard Overview</h2>

        <!-- Summary Cards -->
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="bi bi-car-front-fill text-primary fs-1 me-3"></i>
                        <div>
                            <div class="fw-semibold text-muted">Total Vehicles</div>
                            <div class="fs-4 fw-bold">@Model.TotalCars</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-info fs-1 me-3"></i>
                        <div>
                            <div class="fw-semibold text-muted">Available Cars</div>
                            <div class="fs-4 fw-bold">@Model.ActiveVehicles</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="bi bi-cash-stack text-success fs-1 me-3"></i>
                        <div>
                            <div class="fw-semibold text-muted">Car Inventory</div>
                            <div class="fs-4 fw-bold">$@Model.VehiclePrice</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="bi bi-currency-dollar text-success fs-1 me-3"></i>
                        <div>
                            <div class="fw-semibold text-muted">Car Sales</div>
                            <div class="fs-4 fw-bold">@Model.TotalSales.ToString("F2")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Stats -->
        <div class="row g-4 mt-2">
            <div class="col-md-3">
                <div class="card text-center shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body">
                        <div class="fs-3 fw-bold text-success">8</div>
                        <div class="text-muted">Vehicle Brands</div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="bi bi-people-fill text-warning fs-1 me-3"></i>
                        <div>
                            <div class="fs-4 fw-bold">@Model.TotalUsers</div>
                            <div class="fw-semibold text-muted">Total Users</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body">
                        <div class="fs-3 fw-bold text-danger">$@Model.AccessoriesTotal</div>
                        <div class="text-muted">Accessory Inventory</div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center shadow-sm border-1 rounded-3 h-100">
                    <div class="card-body">
                        <div class="fs-3 fw-bold text-danger">$@Model.AccessoriesSales</div>
                        <div class="text-muted">Accessory Sales</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Analytics -->
    <div class="analytics-section mt-4">
        <h2>Inventory Analytics</h2>

        <div class="analytics-grid">
            <div class="analytics-chart">
                <canvas id="stockSoldChart"></canvas>
            </div>

            <div class="analytics-metrics">
                <div class="metric-card">
                    <div class="metric-title">Top Selling Brand</div>
                    <div class="metric-value">@Model.TopBrandName</div>
                    <div class="metric-detail">@Model.TopBrandSalesPercent% of total sales</div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">Average Sale Price</div>
                    <div class="metric-value" id="average-sale">$@Model.AverageSale.ToString("F2")</div>
                    <div class="metric-detail">Per vehicle transaction</div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">Total Units Sold</div>
                    <div class="metric-value">@Model.UnitsSold</div>
                    <div class="metric-detail">Vehicles sold this period</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Inventory -->
    <div class="admin-content">
        <div class="admin-section">
            <div class="section-header">
                <h2>Recent Inventory</h2>
                <a href="/Admin/Inventory" class="view-all">View All</a>
            </div>

            <div class="admin-table">
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Vehicle</th>
                            <th>Transmission</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Added Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.RecentInventory != null)
                        {
                            @foreach (var car in (List<ZedCars.Net8.Models.Car>)Model.RecentInventory)
                            {
                                <tr>
                                    <td>@car.Brand @car.Model</td>
                                    <td>@car.Transmission</td>
                                    <td>@car.StockQuantity</td>
                                    <td>$@car.Price</td>
                                    <td>@car?.CreatedDate?.ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">No recent purchases</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Recent Test Drives -->
        <div class="admin-section">
            <div class="section-header">
                <h2>Recent Test Drives</h2>
            </div>

            <div class="admin-table">
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Vehicle</th>
                            <th>Date</th>
                            <th>Phone Number</th>
                            <th>Time Slot</th>
                            <th>Status</th>
                            @if (User.IsInRole("Manager"))
                            {
                                <th>Actions</th>
                            }
                        </tr>
                    </thead>

                    <tbody>
                        @if (Model.RecentBookings != null)
                        {
                            @foreach (var td in Model.RecentBookings)
                            {
                                <tr>
                                    <td>@td.CustomerName</td>
                                    <td>@td?.Car?.Brand - @td?.Car?.Model</td>
                                    <td>@td.BookingDate.ToString("yyyy-MM-dd")</td>
                                    <td>@td.CustomerPhone</td>
                                    <td>@td.TimeSlot</td>
                                    <td>@td.Status</td>

                                    @if (User.IsInRole("Manager"))
                                    {
                                        <td>
                                            @if (td.Status == "Pending")
                                            {
                                                <form method="post" action="/Admin/UpdateTestDriveStatus" class="d-flex">
                                                    <input type="hidden" name="testDriveId" value="@td.TestDriveId" />
                                                    <input type="hidden" name="status" value="Done" />
                                                    <button type="submit" class="btn btn-sm btn-outline-success">
                                                        <i class="bi bi-check-circle"></i> Done
                                                    </button>
                                                </form>
                                            }
                                            else if(td.Status == "Done")
                                            {
                                                <form method="post" action="/Admin/UpdateTestDriveStatus" class="d-inline">
                                                    <input type="hidden" name="testDriveId" value="@td.TestDriveId" />
                                                    <input type="hidden" name="status" value="Pending" />
                                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-arrow-counterclockwise"></i> Unmark
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <span class="text-success">@td.Status</span>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center">No recent test drives</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User Activity -->
    <div class="user-activity-section">
        <div class="section-header d-flex justify-content-between align-items-center border-bottom">
            <h2 class="fw-bold text-primary mb-0">
                <i class="bi bi-activity me-2"></i> User Activity
            </h2>
            <a href="/Admin/UserActivity" class="view-all">View All</a>
        </div>

        <div class="activity-timeline p-3 bg-light">
            @if (Model.RecentActivities != null && Model.RecentActivities.Any())
            {
                @foreach (var activity in Model.RecentActivities)
                {
                    <div class="card mb-3 border-0 border-start border-4 border-primary shadow-sm">
                        <div class="card-body d-flex">
                            <div class="fs-3 me-3">
                                @switch (activity.ActivityType)
                                {
                                    case "Registration":
                                        @Html.Raw("üë§")
                                        break;
                                    case "Test Drive":
                                        @Html.Raw("üöó")
                                        break;
                                    case "Purchase":
                                        @Html.Raw("üí∞")
                                        break;
                                    case "Accessory Purchase":
                                        @Html.Raw("üîß")
                                        break;
                                    default:
                                        @Html.Raw("üìù")
                                        break;
                                }
                            </div>

                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 text-dark">@activity.ActivityType</h5>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        @activity.ActivityDate.ToString("MMM dd, yyyy h:mm tt")
                                    </small>
                                </div>

                                <div class="mb-1">
                                    <strong class="text-primary">@activity.Username</strong>
                                </div>

                                <p class="mb-2 text-secondary">@activity.Description</p>

                                <span class="badge @(activity.Status == "Success"
                                                                          ? "bg-success"
                                                                          : activity.Status == "Failed"
                                                                              ? "bg-danger"
                                                                              : "bg-warning text-dark")">
                            @activity.Status
                        </span>
                    </div>
                </div>
            </div>
                        }
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-clock-history display-6 d-block mb-2"></i>
                    <span>No recent activities found.</span>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .admin-header {
        background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
        color: white;
        padding: 30px;
        /* margin: -30px -30px 30px -30px; */
        /* border-radius: 8px 8px 0 0; */
        /* margin-top:10px; */
    }
    
    .admin-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        flex-direction: row;
    }
    
    .btn {
        padding: 10px 20px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: bold;
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }
    .dashboard-overview{
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        padding: 20px;
    }
    /* Dashboard Summary */
    .dashboard-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        align-items: center;
    }
    
    .summary-icon {
        font-size: 24px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }
    
    .sales-icon {
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
    }
    
    .visitors-icon {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
    }
    
    .conversion-icon {
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
    }
    
    .inventory-icon {
        background: rgba(230, 126, 34, 0.1);
        color: #e67e22;
    }
    
    .summary-content {
        flex: 1;
    }
    
    .summary-title {
        color: #7f8c8d;
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .summary-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    /* Admin Stats */
    .admin-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .stat-label {
        color: #7f8c8d;
        margin-top: 5px;
    }
    
    /* Analytics Section */
    .analytics-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        padding: 20px;
    }
    
    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .analytics-header h2 {
        margin: 0;
    }
    
    .analytics-period select {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .analytics-grid {
        display: grid;
        grid-template-columns: 2fr;
        gap: 20px;
    }
   
    .analytics-chart {
        width: 100%;
        max-width: 700px;
        height: 400px; /* Chart height */
        margin: 0 auto;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .analytics-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .metric-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    
    .metric-title {
        font-size: 12px;
        color: #7f8c8d;
        margin-bottom: 5px;
    }
    
    .metric-value {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .metric-detail {
        font-size: 12px;
        color: #7f8c8d;
    }
    
    /* Admin Section */
    .admin-section {
        background: white;
        /* border-radius: 8px; */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        overflow: hidden;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #f8f9fa;
        border-bottom: 1px groove #e9ecef;
    }

    .section-header p {
        margin-bottom: 0 !important;
    }
    
    .section-header h2 {
        margin: 0;
        font-size: 1.2em;
    }
    
    .view-all {
        color: #3498db;
        text-decoration: none;
        font-size: 0.9em;
    }
    
    .admin-table {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0 !important;
    }
    
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }
    
    th {
        background: #f8f9fa;
        font-weight: bold;
        color: #2c3e50;
    }
    
    tr:hover {
        background: #f8f9fa;
    }
    
    .status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
    }
    
    .status.available {
        background: #d4edda;
        color: #155724;
    }
    
    .status.reserved {
        background: #fff3cd;
        color: #856404;
    }
    
    .status.sold {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status.new {
        background: #cce5ff;
        color: #004085;
    }
    
    .status.replied {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .status.closed {
        background: #e2e3e5;
        color: #383d41;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .btn-icon {
        display: inline-block;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        border-radius: 4px;
        text-decoration: none;
    }
    
    .btn-icon.edit {
        background: #e9ecef;
    }
    
    .btn-icon.delete {
        background: #f8d7da;
    }
    
    .btn-icon.view {
        background: #d1ecf1;
    }
    
    .btn-icon.reply {
        background: #d4edda;
    }
    
    /* User Activity Timeline */
    .user-activity-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .timeline-item {
        display: flex;
        margin-bottom: 20px;
        position: relative;
    }
    
    .timeline-item:not(:last-child):before {
        content: '';
        position: absolute;
        left: 20px;
        top: 40px;
        bottom: -20px;
        width: 2px;
        background: #e9ecef;
    }
    
    .timeline-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        z-index: 1;
    }
    
    .timeline-content {
        flex: 1;
    }
    
    .timeline-time {
        font-size: 12px;
        color: #7f8c8d;
        margin-bottom: 5px;
    }
    
    .timeline-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .timeline-description {
        font-size: 14px;
        color: #2c3e50;
    }

    .user-activity-section {
        max-width: 100%;
        margin: auto;
    }

    .timeline-item {
        position: relative;
    }

    .timeline-item::before {
        content: "";
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }

    .timeline-icon {
        width: 40px;
        height: 40px;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        z-index: 1;
    }

    .timeline-content {
        position: relative;
        margin-left: 60px;
    }

    .section-header h2 {
        font-size: 1.5rem;
    }

    .section-header span {
        font-weight: 500;
    }

</style>

@section Scripts {
    @* <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> *@
    <script>
        let stockSoldChart;
        const ctx = document.getElementById('stockSoldChart').getContext('2d');

        // Initialize chart
        function initChart() {
            stockSoldChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Stock Available',
                            data: [],
                            backgroundColor: '#2ecc71'
                        },
                        {
                            label: 'Units Sold',
                            data: [],
                            backgroundColor: '#e74c3c'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Stock Available vs Units Sold by Brand'
                        },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Units'
                            }
                        }
                    }
                }
            });
        }

        // Load stock vs sold data
        async function loadSalesData(period = 'month') {
            try {
                const response = await fetch(`/Admin/GetStockVsSoldData?period=${period}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading stock data:', data.error);
                    return;
                }

                // Update chart
                const brands = data.stockData.map(s => s.brand);
                const stockAvailable = data.stockData.map(s => s.stockAvailable);
                const unitsSold = data.stockData.map(s => s.unitsSold);

                stockSoldChart.data.labels = brands;
                stockSoldChart.data.datasets[0].data = stockAvailable;
                stockSoldChart.data.datasets[1].data = unitsSold;
                stockSoldChart.update();

                // Update metrics
                document.getElementById('average-sale').textContent = `$${data.averageSale.toFixed(2)}`;

                
                // Update turnover detail based on comparison
                const turnoverDetail = data.inventoryTurnover < 20 ? 
                    `${20 - data.inventoryTurnover} days better than average` : 
                    `${data.inventoryTurnover - 20} days above average`;


            } catch (error) {
                console.error('Error fetching stock data:', error);
            }
        }


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadSalesData('month'); // Load default data
        });
    </script>
}
